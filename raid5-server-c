#!/bin/bash

# === full-backup-with-versioning.sh ===
# Назначение: Автоматическое резервное копирование с Linux-клиента на сервер с RAID, с версионированием
# Подходит как основная реализация дипломной практики
# Требуется: inotify-tools, доступ по SSH к серверу

# Параметры
SOURCE="/home/user/"
DEST="user@192.168.1.10:/backup/client-linux/"
VERSION_DIR="user@192.168.1.10:/backup/versions/client-linux/"

# Первый запуск — полное резервное копирование
echo "[*] Выполняется полное резервное копирование..."
rsync -avz "$SOURCE" "$DEST"

# Запуск мониторинга изменений
echo "[*] Слежение за изменениями в: $SOURCE"
inotifywait -mrq -e modify,create,delete,move "$SOURCE" | while read change; do
    echo "[+] Изменение обнаружено: $change"

    # Получение временной метки
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)

    # Сохранение текущей версии перед синхронизацией
    echo "[*] Сохраняем текущую версию: ${TIMESTAMP}"
    ssh user@192.168.1.10 "cp -a /backup/client-linux /backup/versions/client-linux-${TIMESTAMP}"

    # Синхронизация актуального состояния
    echo "[*] Выполняется rsync..."
    rsync -avz "$SOURCE" "$DEST"
done
